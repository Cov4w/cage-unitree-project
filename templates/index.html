<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Unitree ì œì–´ ì‹œìŠ¤í…œ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px; /* ê°€ë¡œ ë ˆì´ì•„ì›ƒì„ ìœ„í•´ ë” ë„“ê²Œ */
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* ğŸ†• ê°€ë¡œ ë°°ì¹˜ë¥¼ ìœ„í•œ ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .main-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        
        /* ğŸ†• ë¹„ë””ì˜¤ ì„¹ì…˜ ìŠ¤íƒ€ì¼ ìˆ˜ì • */
        .video-section {
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease; /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ */
        }
        
        .video-section.expanded {
            /* START CONTROL í›„ ë¹„ë””ì˜¤ê°€ ì™¼ìª½ìœ¼ë¡œ ì´ë™ */
            flex: 0 0 640px; /* ê³ ì • ë„ˆë¹„ */
            margin-bottom: 0;
        }
        
        .video-stream {
            border: 2px solid #ddd;
            border-radius: 10px;
            width: 640px !important;        /* ê°•ì œ ê³ ì • */
            height: 360px !important;       /* ê°•ì œ ê³ ì • */
        }
        
        /* ğŸ†• ì œì–´ íŒ¨ë„ì´ ì˜¤ë¥¸ìª½ì— í‘œì‹œë  ì˜ì—­ */
        .control-sidebar {
            flex: 1;
            min-width: 300px;
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
        }
        
        .control-sidebar.active {
            display: block;
            animation: slideInRight 0.3s ease-out; /* ìŠ¬ë¼ì´ë“œ ì• ë‹ˆë©”ì´ì…˜ */
        }
        
        /* ğŸ†• ìŠ¬ë¼ì´ë“œ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .control-section {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        .control-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-warning:hover { background-color: #e0a800; }
        
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-info:hover { background-color: #138496; }
        
        /* ğŸ”§ ì¡°ì´ìŠ¤í‹± ì˜ì—­ ê°œì„ ëœ ìŠ¤íƒ€ì¼ */
        #joystick-zone { 
            width: 200px; 
            height: 200px; 
            margin: 20px auto;
            border: 3px solid #007bff;
            border-radius: 50%;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            position: relative;
            overflow: visible;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        /* ğŸ”§ ì¡°ì´ìŠ¤í‹± í˜¸ë²„ íš¨ê³¼ */
        #joystick-zone:hover {
            border-color: #0056b3;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.15), 0 0 15px rgba(0,123,255,0.4);
            transform: scale(1.02);
        }
        
        /* ğŸ”§ ì¡°ì´ìŠ¤í‹± í™œì„±í™” ìƒíƒœ */
        #joystick-zone.active {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.15), 0 0 20px rgba(40,167,69,0.5);
        }
        
        .action-buttons {
            text-align: center;
            margin: 20px 0;
        }
        
        .action-btn { 
            width: 120px; 
            font-size: 1em; 
            margin: 10px; 
        }
        
        .status-display {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .log-area {
            background-color: #212529;
            color: #ffffff;
            padding: 15px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-on { background-color: #28a745; }
        .status-off { background-color: #dc3545; }
        .status-scanning { background-color: #ffc107; }
        
        /* ğŸ†• ì „ì²´ í­ ì‚¬ìš©í•˜ëŠ” ì„¹ì…˜ë“¤ */
        .full-width-section {
            width: 98%;
            margin: 20px 0;
        }
        
        /* ğŸ†• ë°˜ì‘í˜• ë””ìì¸ */
        @media (max-width: 1200px) {
            .main-layout {
                flex-direction: column;
            }
            
            .video-section.expanded {
                flex: none;
            }
            
            .control-sidebar {
                min-width: auto;
            }
        }
        
        /* ğŸ”§ ë°˜ì‘í˜• ì¡°ì´ìŠ¤í‹± */
        @media (max-width: 768px) {
            #joystick-zone {
                width: 160px;
                height: 160px;
            }
        }
        
        @media (min-width: 1400px) {
            #joystick-zone {
                width: 240px;
                height: 240px;
            }
        }
        
        /* ğŸ†• LIDAR 3D ë·°ì–´ ìŠ¤íƒ€ì¼ */
        #lidar-container {
            position: relative;
            border: 2px solid #28a745;
            border-radius: 10px;
            background: #000;
            width: 640px;
            height: 360px;
            margin: 0 auto;
        }
        
        #lidar-canvas {
            border-radius: 8px;
            display: block;
        }
        
        /* ğŸ†• ë·° í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #toggle-view-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(40,167,69,0.3);
        }
        
        #toggle-view-btn:hover {
            background-color: #1e7e34;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40,167,69,0.4);
        }
        
        #toggle-view-btn.lidar-mode {
            background-color: #007bff;
        }
        
        #toggle-view-btn.lidar-mode:hover {
            background-color: #0056b3;
        }
        
        /* ğŸ†• LIDAR ìƒíƒœ í‘œì‹œ */
        #lidar-status {
            text-align: center;
            padding: 8px;
            border-radius: 5px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
        }
        
        #lidar-status.connected {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        #lidar-status.connecting {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        
        #lidar-status.error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
    </style>
    <!-- ğŸ†• Three.js ë° SocketIO ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– Unitree ì œì–´ ì‹œìŠ¤í…œ</h1>
        
        <!-- ì‹œìŠ¤í…œ ì‹œì‘ ë²„íŠ¼ (ì „ì²´ í­) -->
        <div class="control-section full-width-section">
            <h3>ğŸš€ ì‹œìŠ¤í…œ ì œì–´</h3>
            <button id="slam-btn" class="btn btn-primary">START CONTROL</button>
            <button id="exit-btn" class="btn btn-danger" style="display:none;">EXIT</button>
        </div>

        <!-- ğŸ†• YOLO ì œì–´ ì„¹ì…˜ ì¶”ê°€ -->
        <div class="control-section full-width-section">
            <h3>ğŸ¯ YOLO ê°ì§€ ì‹œìŠ¤í…œ</h3>
            <p style="margin: 5px 0; color: #666;">
                ğŸ”¥ <strong>ê¸°ëŠ¥:</strong> í™”ì¬ ë° ì¸ë¬¼ ê°ì§€ | ArUco ìŠ¤ìº” ì‹œ ìë™ ë¹„í™œì„±í™” | ìˆ˜ë™ í† ê¸€ ê°€ëŠ¥
            </p>
            <div class="status-display" id="yolo-control-status">
                <span class="status-indicator status-on" id="yolo-indicator"></span>
                <strong>YOLO ìƒíƒœ:</strong> <span id="yolo-control-text">í™œì„±í™”</span>
            </div>
            <button onclick="toggleYolo()" class="btn btn-warning" id="yolo-toggle-btn">
                ğŸ¯ YOLO ë¹„í™œì„±í™”
            </button>
            <p style="margin: 5px 0; color: #666; font-size: 0.9em;">
                ğŸ’¡ <strong>ì°¸ê³ :</strong> ArUco ìŠ¤ìº” ì¤‘ì—ëŠ” ìë™ìœ¼ë¡œ YOLOê°€ ë¹„í™œì„±í™”ë˜ë©°, ìŠ¤ìº” ì™„ë£Œ í›„ ìë™ ì¬í™œì„±í™”ë©ë‹ˆë‹¤.
            </p>
        </div>

        <!-- ArUco ì‹ ì› í™•ì¸ ì‹œìŠ¤í…œ (ì „ì²´ í­) -->
        <div class="control-section full-width-section">
            <h3>ğŸ”– ArUco ì‹ ì› í™•ì¸ ì‹œìŠ¤í…œ</h3>
            <p style="margin: 5px 0; color: #666;">
                ğŸ“‹ <strong>í”„ë¡œì„¸ìŠ¤:</strong> SIT ë²„íŠ¼ â†’ YOLO ë¹„í™œì„±í™” â†’ ArUco ë§ˆì»¤ ìŠ¤ìº” â†’ ì‹ ì› í™•ì¸ â†’ Discord ì•Œë¦¼ â†’ <strong>ìë™ STANDUP ë³µêµ¬</strong>
            </p>
            <div class="status-display" id="aruco-status">
                <span class="status-indicator status-off"></span>
                <strong>ArUco ìŠ¤ìº”:</strong> <span id="aruco-status-text">ëŒ€ê¸° ì¤‘</span>
            </div>
            <button onclick="startArUcoScan()" class="btn btn-success">
                ğŸ”– ArUco ì‹ ì› ìŠ¤ìº” ì‹œì‘
            </button>
            <button onclick="stopArUcoScan()" class="btn btn-danger">
                ğŸ›‘ ArUco ìŠ¤ìº” ì¤‘ì§€ & ë³µêµ¬
            </button>
            <button onclick="checkArUcoStatus()" class="btn btn-info">
                ğŸ“Š ArUco ìƒíƒœ í™•ì¸
            </button>
            <button onclick="checkRobotStatus()" class="btn btn-warning">
                ğŸ¤– ë¡œë´‡ ìƒíƒœ í™•ì¸
            </button>
        </div>

        <!-- ğŸ†• ë©”ì¸ ë ˆì´ì•„ì›ƒ: ë¹„ë””ì˜¤ + ì œì–´ íŒ¨ë„ -->
        <div class="main-layout">
            <!-- ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì„¹ì…˜ -->
            <div class="video-section" id="video-section">
                <h2>ğŸ“¹ ì‹¤ì‹œê°„ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼</h2>
                <img src="{{ url_for('video_feed') }}" class="video-stream" id="video-stream" width=640px height=360px />
                
                <!-- ğŸ†• LIDAR 3D ë·°ì–´ (ìˆ¨ê¹€ ìƒíƒœë¡œ ì‹œì‘) -->
                <div id="lidar-container" style="display: none;">
                    <canvas id="lidar-canvas" width="640" height="360"></canvas>
                </div>
                
                <!-- ğŸ†• ë·° í† ê¸€ ë²„íŠ¼ (START CONTROL í›„ì— í‘œì‹œ) -->
                <div id="view-toggle-section" style="display: none; margin-top: 15px;">
                    <button id="toggle-view-btn" class="btn btn-primary">
                        ğŸ¯ LIDAR ë·°ë¡œ ì „í™˜
                    </button>
                    <div id="lidar-status" style="margin-top: 10px; color: #666; font-size: 0.9em;">
                        ì—°ê²° ìƒíƒœ: ëŒ€ê¸° ì¤‘
                    </div>
                </div>
            </div>

            <!-- ğŸ†• ì œì–´ ì‚¬ì´ë“œë°” (START CONTROL í›„ì— í‘œì‹œ) -->
            <div class="control-sidebar" id="control-sidebar">
                <!-- ì¡°ì´ìŠ¤í‹± ì œì–´ -->
                <div class="control-section">
                    <h3>ğŸ•¹ï¸ ì¡°ì´ìŠ¤í‹± ì œì–´</h3>
                    <div id="joystick-zone"></div>
                    <p style="text-align: center; color: #666; font-size: 0.9em;">
                        ì¡°ì´ìŠ¤í‹±ì„ ë“œë˜ê·¸í•˜ì—¬ ë¡œë´‡ì„ ì›€ì§ì´ì„¸ìš”
                    </p>
                </div>

                <!-- ê¸°ë³¸ ë™ì‘ ë²„íŠ¼ë“¤ -->
                <div class="control-section">
                    <h3>ğŸ¤– ê¸°ë³¸ ë™ì‘</h3>
                    <div class="action-buttons">
                        <button class="action-btn btn btn-warning" onclick="move('sitdown')">SIT DOWN</button>
                        <button class="action-btn btn btn-success" onclick="move('situp')">STAND UP</button>
                        <button class="action-btn btn btn-info" onclick="move('sit')">SIT</button>
                    </div>
                </div>

                <!-- ğŸ”§ ê°„ì†Œí™”ëœ ì˜¤ë””ì˜¤ ì œì–´ -->
                <div class="control-section">
                    <h3>ğŸµ ìŒì„± ì±„ë„ ì—°ë™</h3>
                    <div class="action-buttons">
                        <button class="action-btn btn btn-success" onclick="connectVoiceChannel()">
                            ğŸ”— ìŒì„± ì—°ê²° & ë¸Œë¦¬ì§€ ì‹œì‘
                        </button>
                        <button class="action-btn btn btn-danger" onclick="disconnectVoiceChannel()">
                            ğŸ”‡ ë¸Œë¦¬ì§€ ì¤‘ì§€ & í‡´ì¥
                        </button>
                    </div>
                    <div class="status-display" id="voice-status">
                        <span class="status-indicator status-off"></span>
                        <strong>ìŒì„± ìƒíƒœ:</strong> <span id="voice-status-text">ë¹„í™œì„±í™”</span>
                    </div>
                    <p style="text-align: center; color: #666; font-size: 0.9em;">
                        Discord ìŒì„± ì±„ë„ê³¼ ë¡œë´‡ ì˜¤ë””ì˜¤ë¥¼ ì—°ë™í•©ë‹ˆë‹¤<br>
                        <strong>ì—°ê²° ì‹œ ìë™ìœ¼ë¡œ ì–‘ë°©í–¥ ë¸Œë¦¬ì§€ê°€ í™œì„±í™”ë©ë‹ˆë‹¤</strong>
                    </p>
                </div>
            </div>
        </div>

        <!-- ì‹œìŠ¤í…œ ìƒíƒœ ë° ë¡œê·¸ (ì „ì²´ í­) -->
        <div class="control-section full-width-section">
            <h3>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h3>
            <div class="status-display" id="system-status">
                <span class="status-indicator status-off"></span>
                <strong>YOLO:</strong> <span id="yolo-status">í™œì„±í™”</span> | 
                <strong>ArUco:</strong> <span id="aruco-mode">ëŒ€ê¸°</span> | 
                <strong>ì—°ê²°:</strong> <span id="connection-status">ì¤€ë¹„</span>
            </div>
            
            <h4>ğŸ“ ì‹¤ì‹œê°„ ë¡œê·¸</h4>
            <div class="log-area" id="log-area">
                ì‹œìŠ¤í…œ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
            </div>
            <button onclick="clearLog()" class="btn btn-warning" style="margin-top: 10px;">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <script>
        // ğŸ†• LIDAR ê´€ë ¨ ë³€ìˆ˜ë“¤
        let lidarViewMode = false;
        let lidarScene, lidarCamera, lidarRenderer, lidarPoints;
        let socket;
        
        // ê¸°ì¡´ ë³€ìˆ˜ë“¤
        let joystick = null;
        let current = {x: 0, z: 0};
        let sending = false;
        let intervalId = null;
        let statusMonitorId = null;

        // ë¡œê·¸ í•¨ìˆ˜
        function addLog(message) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-area').innerHTML = 'ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤...\n';
        }

        // ğŸ†• YOLO í† ê¸€ í•¨ìˆ˜ ì¶”ê°€
        function toggleYolo() {
            fetch('/toggle_yolo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`ğŸ¯ ${data.message}`);
                    updateYoloControlStatus(data.yolo_active);
                } else {
                    addLog('âŒ YOLO í† ê¸€ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                addLog('âŒ YOLO í† ê¸€ í†µì‹  ì˜¤ë¥˜: ' + error);
            });
        }

        // ğŸ†• YOLO ì œì–´ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateYoloControlStatus(yoloActive) {
            const indicator = document.getElementById('yolo-indicator');
            const statusText = document.getElementById('yolo-control-text');
            const toggleBtn = document.getElementById('yolo-toggle-btn');
            
            // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
            indicator.className = 'status-indicator';
            if (yoloActive) {
                indicator.classList.add('status-on');
                statusText.textContent = 'í™œì„±í™”';
                toggleBtn.textContent = 'ğŸ¯ YOLO ë¹„í™œì„±í™”';
                toggleBtn.className = 'btn btn-warning';
            } else {
                indicator.classList.add('status-off');
                statusText.textContent = 'ë¹„í™œì„±í™”';
                toggleBtn.textContent = 'ğŸ¯ YOLO í™œì„±í™”';
                toggleBtn.className = 'btn btn-success';
            }
        }

        // ğŸ†• ìŒì„± ê´€ë ¨ JavaScript í•¨ìˆ˜ë“¤ ì¶”ê°€
        function connectVoiceChannel() {
            fetch('/voice_connect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog('ğŸ”— Discord ìŒì„± ì±„ë„ ì—°ê²° ë° ë¸Œë¦¬ì§€ ì‹œì‘ ìš”ì²­ë¨');
                    addLog('ğŸµ ìë™ìœ¼ë¡œ ì–‘ë°©í–¥ ìŒì„± ë¸Œë¦¬ì§€ê°€ í™œì„±í™”ë©ë‹ˆë‹¤');
                    updateVoiceStatus('connecting', 'ì—°ê²° ì¤‘...');
                    
                    // 5ì´ˆ í›„ ìƒíƒœ í™•ì¸
                    setTimeout(checkVoiceStatus, 5000);
                } else {
                    addLog('âŒ ìŒì„± ì±„ë„ ì—°ê²° ì‹¤íŒ¨: ' + data.message);
                    updateVoiceStatus('off', 'ì—°ê²° ì‹¤íŒ¨');
                }
            })
            .catch(error => {
                addLog('âŒ ìŒì„± ì±„ë„ ì—°ê²° ì˜¤ë¥˜: ' + error);
                updateVoiceStatus('off', 'ì—°ê²° ì˜¤ë¥˜');
            });
        }

        function disconnectVoiceChannel() {
            fetch('/voice_disconnect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog('ğŸ”‡ ìŒì„± ë¸Œë¦¬ì§€ ì¤‘ì§€ ë° Discord ë´‡ í‡´ì¥ ìš”ì²­ë¨');
                    addLog('ğŸ¤– ìë™ìœ¼ë¡œ ëª¨ë“  ìŒì„± ì—°ê²°ì´ í•´ì œë©ë‹ˆë‹¤');
                    updateVoiceStatus('off', 'ë¹„í™œì„±í™”');
                } else {
                    addLog('âŒ ìŒì„± ì±„ë„ ì—°ê²° í•´ì œ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                addLog('âŒ ìŒì„± ì±„ë„ ì—°ê²° í•´ì œ ì˜¤ë¥˜: ' + error);
            });
        }

        function updateVoiceStatus(status, text) {
            const indicator = document.querySelector('#voice-status .status-indicator');
            const statusText = document.getElementById('voice-status-text');
            
            indicator.className = 'status-indicator';
            if (status === 'active') {
                indicator.classList.add('status-on');
            } else if (status === 'connecting') {
                indicator.classList.add('status-scanning');
            } else {
                indicator.classList.add('status-off');
            }
            
            statusText.textContent = text;
        }

        function checkVoiceStatus() {
            fetch('/voice_status')
            .then(response => response.json())
            .then(data => {
                if (data.voice_connected && data.bridge_active) {
                    updateVoiceStatus('active', 'ì–‘ë°©í–¥ ë¸Œë¦¬ì§€ í™œì„±í™”');
                    addLog('âœ… ìŒì„± ì—°ê²° ë° ë¸Œë¦¬ì§€ í™œì„±í™” ì™„ë£Œ!');
                    addLog('ğŸ—£ï¸ Discord ìŒì„± â†’ ë¡œë´‡ ìŠ¤í”¼ì»¤');
                    addLog('ğŸ”Š ë¡œë´‡ ë§ˆì´í¬ â†’ Discord ìŒì„±');
                } else if (data.voice_connected) {
                    updateVoiceStatus('connecting', 'ì—°ê²°ë¨ (ë¸Œë¦¬ì§€ ëŒ€ê¸°)');
                } else {
                    updateVoiceStatus('off', 'ë¹„í™œì„±í™”');
                }
            })
            .catch(error => {
                console.error('ìŒì„± ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                updateVoiceStatus('off', 'ìƒíƒœ í™•ì¸ ì‹¤íŒ¨');
            });
        }

        // ğŸ”§ ì‹œìŠ¤í…œ ì‹œì‘ (ë ˆì´ì•„ì›ƒ ë³€ê²½ í¬í•¨)
        document.getElementById('slam-btn').onclick = function() {
            fetch('/start_control', {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        // ğŸ†• ë ˆì´ì•„ì›ƒ ë³€ê²½ - ë¹„ë””ì˜¤ë¥¼ ì™¼ìª½ìœ¼ë¡œ, ì œì–´íŒ¨ë„ì„ ì˜¤ë¥¸ìª½ìœ¼ë¡œ
                        document.getElementById('video-section').classList.add('expanded');
                        document.getElementById('control-sidebar').classList.add('active');
                        
                        // ğŸ†• LIDAR í† ê¸€ ë²„íŠ¼ í‘œì‹œ
                        document.getElementById('view-toggle-section').style.display = 'block';
                        
                        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                        document.getElementById('slam-btn').style.display = 'none';
                        document.getElementById('exit-btn').style.display = 'inline-block';
                        
                        addLog('ğŸš€ ì œì–´ ì‹œìŠ¤í…œì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        addLog('ğŸ”„ ë ˆì´ì•„ì›ƒì´ ê°€ë¡œ ë°°ì¹˜ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        addLog('ğŸ¯ LIDAR ë·° í† ê¸€ ë²„íŠ¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        
                        // ğŸ”§ ì¡°ì´ìŠ¤í‹± ìƒì„± (ë ˆì´ì•„ì›ƒ ë³€ê²½ í›„)
                        if (!joystick) {
                            setTimeout(createJoystick, 300); // ë ˆì´ì•„ì›ƒ ë³€ê²½ ì™„ë£Œ ëŒ€ê¸°
                        }
                        startStatusMonitoring();
                    } else {
                        addLog('âŒ ì œì–´ ì‹œìŠ¤í…œ ì‹œì‘ ì‹¤íŒ¨');
                    }
                })
                .catch(error => {
                    addLog('âŒ í†µì‹  ì˜¤ë¥˜: ' + error);
                });
        };

        // ğŸ”§ ì‹œìŠ¤í…œ ì¢…ë£Œ (ë ˆì´ì•„ì›ƒ ë³µì› í¬í•¨)
        document.getElementById('exit-btn').onclick = function() {
            // ğŸ†• ë ˆì´ì•„ì›ƒ ë³µì› - ì›ë˜ ì„¸ë¡œ ë°°ì¹˜ë¡œ
            document.getElementById('video-section').classList.remove('expanded');
            document.getElementById('control-sidebar').classList.remove('active');
            
            // ğŸ†• LIDAR í† ê¸€ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            document.getElementById('view-toggle-section').style.display = 'none';
            
            // ğŸ†• LIDAR ë·°ê°€ í™œì„±í™”ëœ ê²½ìš° ë¹„ë””ì˜¤ë¡œ ë³µì›
            if (lidarViewMode) {
                toggleView(); // ë¹„ë””ì˜¤ ë·°ë¡œ ì „í™˜
            }
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            document.getElementById('slam-btn').style.display = 'inline-block';
            document.getElementById('exit-btn').style.display = 'none';
            
            stopSending();
            stopStatusMonitoring();
            
            // ì¡°ì´ìŠ¤í‹± ì œê±°
            if (joystick) {
                joystick.destroy();
                joystick = null;
            }
            
            addLog('ğŸ›‘ ì œì–´ ì‹œìŠ¤í…œì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            addLog('ğŸ”„ ë ˆì´ì•„ì›ƒì´ ì›ë˜ëŒ€ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
        };

        // ê¸°ë³¸ ë™ì‘ í•¨ìˆ˜ (ê¸°ì¡´ ìœ ì§€)
        function move(direction) {
            fetch('/move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ direction: direction })
            })
            .then(res => res.json())
            .then (data => {
                addLog(`ğŸ¤– ë™ì‘ ëª…ë ¹: ${direction}`);
            })
            .catch(error => {
                addLog('âŒ ë™ì‘ ëª…ë ¹ ì‹¤íŒ¨: ' + error);
            });
        }

        // ArUco í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ìœ ì§€)
        function startArUcoScan() {
            fetch('/start_aruco_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`ğŸ”– ArUco ì‹ ì› ìŠ¤ìº” ì‹œì‘!`);
                    addLog(`ğŸ“‹ ìµœëŒ€ ${data.max_attempts}ë²ˆ ì‹œë„, ${data.timeout}ì´ˆ íƒ€ì„ì•„ì›ƒ`);
                    addLog(`ğŸ¯ YOLO ëª¨ë¸ ë¹„í™œì„±í™”ë¨`);
                    updateArUcoStatus('scanning', 'ArUco ìŠ¤ìº” ì¤‘...');
                    // ğŸ†• YOLO ì œì–´ ìƒíƒœë„ ì—…ë°ì´íŠ¸
                    updateYoloControlStatus(false);
                    startStatusMonitoring();
                } else {
                    addLog('âŒ ArUco ìŠ¤ìº” ì‹œì‘ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                addLog('âŒ ArUco ìŠ¤ìº” í†µì‹  ì˜¤ë¥˜');
            });
        }

        // ğŸ†• ArUco ìŠ¤ìº” ì¤‘ì§€ í•¨ìˆ˜ ê°œì„ 
        function stopArUcoScan() {
            fetch('/stop_aruco_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`ğŸ›‘ ArUco ìŠ¤ìº” ì¤‘ì§€ë¨! (${data.attempts_made}ë²ˆ ì‹œë„í•¨)`);
                    addLog(`ğŸ”„ YOLO ëª¨ë¸ ì¬í™œì„±í™”ë¨`);
                    
                    // ğŸ†• ë¡œë´‡ ë³µêµ¬ ìƒíƒœ í‘œì‹œ
                    if (data.robot_recovered) {
                        addLog(`ğŸ¤– ë¡œë´‡ ìì„¸ ë³µêµ¬ ì™„ë£Œ (ì´ì „ ìƒíƒœ: ${data.previous_robot_state})`);
                        addLog(`ğŸ¤– í˜„ì¬ ë¡œë´‡ì´ standup ìì„¸ë¡œ ë³µê·€í–ˆìŠµë‹ˆë‹¤`);
                    }
                    
                    updateArUcoStatus('off', 'ëŒ€ê¸° ì¤‘ (ë³µêµ¬ ì™„ë£Œ)');
                    // ğŸ†• YOLO ì œì–´ ìƒíƒœë„ ì—…ë°ì´íŠ¸
                    updateYoloControlStatus(true);
                    
                    // 3ì´ˆ í›„ ìƒíƒœ ë©”ì‹œì§€ ì •ë¦¬
                    setTimeout(() => {
                        updateArUcoStatus('off', 'ëŒ€ê¸° ì¤‘');
                    }, 3000);
                    
                } else {
                    addLog('âŒ ArUco ìŠ¤ìº” ì¤‘ì§€ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                addLog('âŒ ArUco ìŠ¤ìº” ì¤‘ì§€ í†µì‹  ì˜¤ë¥˜');
            });
        }

        function checkArUcoStatus() {
            fetch('/aruco_scan_status')
            .then(response => response.json())
            .then(data => {
                addLog(`ğŸ“Š ArUco ìƒíƒœ:`);
                addLog(`   ìŠ¤ìº” ëª¨ë“œ: ${data.aruco_scan_mode ? 'ON' : 'OFF'}`);
                addLog(`   ì‹œë„ íšŸìˆ˜: ${data.aruco_scan_attempts}/${data.max_attempts}`);
                addLog(`   ë‚¨ì€ ì‹œê°„: ${data.remaining_time.toFixed(1)}ì´ˆ`);
                addLog(`   YOLO í™œì„±í™”: ${data.yolo_active ? 'ON' : 'OFF'}`);
            })
            .catch(error => {
                addLog('âŒ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨');
            });
        }

        function updateArUcoStatus(status, text) {
            const indicator = document.querySelector('#aruco-status .status-indicator');
            const statusText = document.getElementById('aruco-status-text');
            
            indicator.className = 'status-indicator';
            if (status === 'scanning') {
                indicator.classList.add('status-scanning');
            } else if (status === 'on') {
                indicator.classList.add('status-on');
            } else {
                indicator.classList.add('status-off');
            }
            
            statusText.textContent = text;
        }

        // ğŸ”§ ìƒíƒœ ëª¨ë‹ˆí„°ë§ì— YOLO ìƒíƒœ ì¶”ê°€
        function startStatusMonitoring() {
            if (statusMonitorId) return;
            
            statusMonitorId = setInterval(() => {
                // ê¸°ì¡´ ArUco ìƒíƒœ í™•ì¸
                fetch('/aruco_scan_status')
                .then(response => response.json())
                .then(data => {
                    // YOLO ìƒíƒœ ì—…ë°ì´íŠ¸ (ì‹œìŠ¤í…œ ìƒíƒœ ì˜ì—­)
                    document.getElementById('yolo-status').textContent = data.yolo_active ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”';
                    
                    // ğŸ†• YOLO ì œì–´ ìƒíƒœë„ ì—…ë°ì´íŠ¸
                    updateYoloControlStatus(data.yolo_active);
                    
                    // ArUco ëª¨ë“œ ì—…ë°ì´íŠ¸
                    if (data.aruco_scan_mode) {
                        document.getElementById('aruco-mode').textContent = `ìŠ¤ìº” ì¤‘ (${data.aruco_scan_attempts}/${data.max_attempts})`;
                        updateArUcoStatus('scanning', `ìŠ¤ìº” ì¤‘... ${data.aruco_scan_attempts}/${data.max_attempts}`);
                    } else {
                        document.getElementById('aruco-mode').textContent = 'ëŒ€ê¸°';
                        updateArUcoStatus('off', 'ëŒ€ê¸° ì¤‘');
                    }
                    
                    // ì—°ê²° ìƒíƒœ
                    document.getElementById('connection-status').textContent = 'ì—°ê²°ë¨';
                })
                .catch(error => {
                    document.getElementById('connection-status').textContent = 'ì—°ê²° ì˜¤ë¥˜';
                });
                
                // ğŸ†• ìŒì„± ìƒíƒœ í™•ì¸ ì¶”ê°€
                checkVoiceStatus();
                
            }, 3000); // 3ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
        }

        function stopStatusMonitoring() {
            if (statusMonitorId) {
                clearInterval(statusMonitorId);
                statusMonitorId = null;
            }
        }

        // ğŸ”§ ì¡°ì´ìŠ¤í‹± ìƒì„± í•¨ìˆ˜ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        function createJoystick() {
            console.log('ğŸ•¹ï¸ ì¡°ì´ìŠ¤í‹± ìƒì„± ì‹œì‘...');
            
            const joystickZone = document.getElementById('joystick-zone');
            if (!joystickZone) {
                console.error('âŒ joystick-zone ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                addLog('âŒ ì¡°ì´ìŠ¤í‹± ì˜ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ê¸°ì¡´ ì¡°ì´ìŠ¤í‹±ì´ ìˆë‹¤ë©´ ì œê±°
            if (joystick) {
                try {
                    joystick.destroy();
                } catch (e) {
                    console.warn('âš ï¸ ì¡°ì´ìŠ¤í‹± ì œê±° ì¤‘ ê²½ê³ :', e);
                }
                joystick = null;
            }

            // ğŸ”§ ë ˆì´ì•„ì›ƒ ë³€ê²½ ì™„ë£Œ ëŒ€ê¸°
            setTimeout(() => {
                try {
                    // ğŸ”§ joystick-zone í¬ê¸° ì¸¡ì •
                    const zoneRect = joystickZone.getBoundingClientRect();
                    const zoneSize = Math.min(zoneRect.width, zoneRect.height);
                    const joystickSize = Math.floor(zoneSize * 0.7); // zoneì˜ 70%
                    
                    console.log(`ğŸ¯ ì¡°ì´ìŠ¤í‹± í¬ê¸°: ${joystickSize}px`);

                    // ğŸ”§ nipplejs ì¡°ì´ìŠ¤í‹± ìƒì„± (ê¸°ì¡´ ì„¤ì • ìœ ì§€)
                    joystick = nipplejs.create({
                        zone: joystickZone,
                        mode: 'static',
                        position: { left: '50%', top: '50%' },
                        color: 'blue',
                        size: joystickSize > 0 ? joystickSize : 150 // ê¸°ë³¸ê°’ 150
                    });

                    // ğŸ”§ ê¸°ì¡´ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì™„ì „íˆ ìœ ì§€
                    joystick.on('move', function(evt, data) {
                        if (data && data.distance > 10) {
                            let rad = data.angle.radian;
                            let x = Math.sin(rad) * (data.distance / 100);
                            let z = Math.cos(rad) * (data.distance / -75);
                            current.x = x;
                            current.z = z;
                        } else {
                            current.x = 0;
                            current.z = 0;
                        }
                        if (!sending) startSending();
                    });

                    joystick.on('end', function() {
                        current.x = 0;
                        current.z = 0;
                        sendJoy(0, 0);
                        stopSending();
                        joystickZone.classList.remove('active');
                    });

                    joystick.on('start', function() {
                        joystickZone.classList.add('active');
                    });
                    
                    addLog(`âœ… ì¡°ì´ìŠ¤í‹± ìƒì„± ì™„ë£Œ`);
                    console.log('ğŸ‰ ì¡°ì´ìŠ¤í‹± ìƒì„± ì™„ë£Œ');
                    
                } catch (error) {
                    console.error('âŒ ì¡°ì´ìŠ¤í‹± ìƒì„± ì‹¤íŒ¨:', error);
                    addLog('âŒ ì¡°ì´ìŠ¤í‹± ìƒì„± ì‹¤íŒ¨: ' + error.message);
                }
            }, 300);
        }

        // ğŸ”§ ê¸°ì¡´ ì „ì†¡ í•¨ìˆ˜ë“¤ ì™„ì „íˆ ìœ ì§€
        function startSending() {
            sending = true;
            if (intervalId) return;
            intervalId = setInterval(() => {
                sendJoy(current.x, current.z);
            }, 50);
        }

        function stopSending() {
            sending = false;
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        function sendJoy(x, z) {
            fetch('/joystick', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ x: x, z: z })
            });
        }

        // ğŸ†• LIDAR Three.js ì´ˆê¸°í™”
        function initLidarViewer() {
            const canvas = document.getElementById('lidar-canvas');
            
            // Scene ìƒì„±
            lidarScene = new THREE.Scene();
            lidarScene.background = new THREE.Color(0x000000);
            
            // Camera ìƒì„±
            lidarCamera = new THREE.PerspectiveCamera(75, 640/360, 0.1, 1000);
            lidarCamera.position.set(0, 5, 10);
            lidarCamera.lookAt(0, 0, 0);
            
            // Renderer ìƒì„±
            lidarRenderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            lidarRenderer.setSize(640, 360);
            
            // ì¢Œí‘œì¶• í—¬í¼ ì¶”ê°€
            const axesHelper = new THREE.AxesHelper(2);
            lidarScene.add(axesHelper);
            
            // ê·¸ë¦¬ë“œ í—¬í¼ ì¶”ê°€
            const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
            lidarScene.add(gridHelper);
            
            // ì¡°ëª… ì¶”ê°€
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            lidarScene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            lidarScene.add(directionalLight);
            
            // ë§ˆìš°ìŠ¤ ì»¨íŠ¸ë¡¤ ì¶”ê°€ (OrbitControls ëŒ€ì‹  ê°„ë‹¨í•œ ì»¨íŠ¸ë¡¤)
            addSimpleMouseControls();
            
            console.log("âœ… LIDAR 3D ë·°ì–´ ì´ˆê¸°í™” ì™„ë£Œ");
        }
        
        // ğŸ†• ê°„ë‹¨í•œ ë§ˆìš°ìŠ¤ ì»¨íŠ¸ë¡¤
        function addSimpleMouseControls() {
            const canvas = document.getElementById('lidar-canvas');
            let isMouseDown = false;
            let mouseX = 0, mouseY = 0;
            
            canvas.addEventListener('mousedown', (event) => {
                isMouseDown = true;
                mouseX = event.clientX;
                mouseY = event.clientY;
            });
            
            canvas.addEventListener('mouseup', () => {
                isMouseDown = false;
            });
            
            canvas.addEventListener('mousemove', (event) => {
                if (!isMouseDown) return;
                
                const deltaX = event.clientX - mouseX;
                const deltaY = event.clientY - mouseY;
                
                // ì¹´ë©”ë¼ íšŒì „
                const spherical = new THREE.Spherical();
                spherical.setFromVector3(lidarCamera.position);
                spherical.theta -= deltaX * 0.01;
                spherical.phi += deltaY * 0.01;
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
                
                lidarCamera.position.setFromSpherical(spherical);
                lidarCamera.lookAt(0, 0, 0);
                
                mouseX = event.clientX;
                mouseY = event.clientY;
            });
            
            // íœ  ì¤Œ
            canvas.addEventListener('wheel', (event) => {
                const distance = lidarCamera.position.length();
                const newDistance = Math.max(2, Math.min(50, distance + event.deltaY * 0.01));
                lidarCamera.position.normalize().multiplyScalar(newDistance);
                event.preventDefault();
            });
        }
        
        // ğŸ†• LIDAR ë°ì´í„° ì—…ë°ì´íŠ¸
        function updateLidarPoints(pointsData, scalars) {
            if (!lidarScene) return;
            
            // ê¸°ì¡´ í¬ì¸íŠ¸ ì œê±°
            if (lidarPoints) {
                lidarScene.remove(lidarPoints);
            }
            
            if (!pointsData || pointsData.length === 0) return;
            
            // í¬ì¸íŠ¸ ì§€ì˜¤ë©”íŠ¸ë¦¬ ìƒì„±
            const geometry = new THREE.BufferGeometry();
            const positions = new Float32Array(pointsData.flat());
            const colors = new Float32Array(pointsData.length * 3);
            
            // ê±°ë¦¬ ê¸°ë°˜ ìƒ‰ìƒ ê³„ì‚°
            for (let i = 0; i < pointsData.length; i++) {
                const scalar = scalars[i] || 0;
                const normalizedScalar = Math.min(1, scalar / 10); // 10më¥¼ ìµœëŒ€ê°’ìœ¼ë¡œ ì •ê·œí™”
                
                // ê±°ë¦¬ì— ë”°ë¥¸ ìƒ‰ìƒ (íŒŒë€ìƒ‰ -> ì´ˆë¡ìƒ‰ -> ë¹¨ê°„ìƒ‰)
                colors[i * 3] = normalizedScalar;     // R
                colors[i * 3 + 1] = 1 - normalizedScalar; // G
                colors[i * 3 + 2] = 0.2;              // B
            }
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            
            // í¬ì¸íŠ¸ ë¨¸í‹°ë¦¬ì–¼ ìƒì„±
            const material = new THREE.PointsMaterial({
                size: 0.05,
                vertexColors: true,
                transparent: true,
                opacity: 0.8
            });
            
            // í¬ì¸íŠ¸ ë©”ì‹œ ìƒì„±
            lidarPoints = new THREE.Points(geometry, material);
            lidarScene.add(lidarPoints);
            
            console.log(`ğŸ“Š LIDAR í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸: ${pointsData.length}ê°œ`);
        }
        
        // ğŸ†• LIDAR ë Œë”ë§ ë£¨í”„
        function animateLidar() {
            if (lidarViewMode && lidarRenderer && lidarScene && lidarCamera) {
                lidarRenderer.render(lidarScene, lidarCamera);
            }
            requestAnimationFrame(animateLidar);
        }
        
        // ğŸ†• ë·° í† ê¸€ í•¨ìˆ˜
        function toggleView() {
            lidarViewMode = !lidarViewMode;
            
            const videoStream = document.getElementById('video-stream');
            const lidarContainer = document.getElementById('lidar-container');
            const toggleBtn = document.getElementById('toggle-view-btn');
            
            if (lidarViewMode) {
                // LIDAR ë·°ë¡œ ì „í™˜
                videoStream.style.display = 'none';
                lidarContainer.style.display = 'block';
                toggleBtn.textContent = 'ğŸ“¹ ë¹„ë””ì˜¤ë¡œ ì „í™˜';
                toggleBtn.classList.add('lidar-mode');
                
                // LIDAR ìŠ¤íŠ¸ë¦¼ ì‹œì‘
                fetch('/toggle_lidar_view', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('LIDAR ë·° ì „í™˜:', data);
                        updateLidarStatus('connected', 'LIDAR ì—°ê²°ë¨');
                    })
                    .catch(error => {
                        console.error('LIDAR ì „í™˜ ì˜¤ë¥˜:', error);
                        updateLidarStatus('error', 'ì—°ê²° ì˜¤ë¥˜');
                    });
                    
            } else {
                // ë¹„ë””ì˜¤ ë·°ë¡œ ì „í™˜
                videoStream.style.display = 'block';
                lidarContainer.style.display = 'none';
                toggleBtn.textContent = 'ğŸ¯ LIDAR ë·°ë¡œ ì „í™˜';
                toggleBtn.classList.remove('lidar-mode');
                
                // ë¹„ë””ì˜¤ ë·°ë¡œ ì „í™˜
                fetch('/toggle_lidar_view', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        console.log('ë¹„ë””ì˜¤ ë·° ì „í™˜:', data);
                        updateLidarStatus('connecting', 'ëŒ€ê¸° ì¤‘');
                    });
            }
        }
        
        // ğŸ†• LIDAR ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateLidarStatus(status, message) {
            const statusElement = document.getElementById('lidar-status');
            statusElement.className = '';
            statusElement.classList.add(status);
            statusElement.textContent = `ì—°ê²° ìƒíƒœ: ${message}`;
        }
        
        // ğŸ†• SocketIO ì´ˆê¸°í™”
        function initSocketIO() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('âœ… SocketIO ì—°ê²°ë¨');
                updateLidarStatus('connecting', 'ì„œë²„ ì—°ê²°ë¨');
            });
            
            socket.on('disconnect', function() {
                console.log('âŒ SocketIO ì—°ê²° í•´ì œë¨');
                updateLidarStatus('error', 'ì„œë²„ ì—°ê²° í•´ì œë¨');
            });
            
            socket.on('lidar_data', function(data) {
                if (data.points && data.scalars) {
                    updateLidarPoints(data.points, data.scalars);
                    updateLidarStatus('connected', `${data.points.length}ê°œ í¬ì¸íŠ¸`);
                    
                    // ğŸ”§ ë°±ê·¸ë¼ìš´ë“œì—ì„œë„ ì²˜ë¦¬í•˜ë˜, LIDAR ë·°ì¼ ë•Œë§Œ í™”ë©´ ì—…ë°ì´íŠ¸
                    if (lidarViewMode) {
                        // LIDAR ë·° ëª¨ë“œì¼ ë•Œë§Œ ì‹œê°ì  ì—…ë°ì´íŠ¸
                        console.log(`ğŸ“Š LIDAR í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸: ${data.points.length}ê°œ`);
                    }
                }
            });
            
            socket.on('status', function(data) {
                console.log('ì„œë²„ ìƒíƒœ:', data.message);
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            addLog('ğŸŒŸ ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.');
            addLog('ğŸ“‹ START CONTROLì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.');
            
            // ğŸ†• LIDAR ì´ˆê¸°í™”
            initLidarViewer();
            initSocketIO();
            animateLidar(); // ë Œë”ë§ ë£¨í”„ ì‹œì‘
            
            // ğŸ†• í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
            document.getElementById('toggle-view-btn').onclick = toggleView;
            
            // ğŸ†• í˜ì´ì§€ ë¡œë“œ ì‹œ YOLO ìƒíƒœ ì´ˆê¸°í™”
            updateYoloControlStatus(true);
            
            // ğŸ†• í˜ì´ì§€ ë¡œë“œ ì‹œ ìŒì„± ìƒíƒœ í•œ ë²ˆ í™•ì¸
            setTimeout(checkVoiceStatus, 1000);
        };
    </script>
</body>
</html>