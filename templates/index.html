<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Unitree ì œì–´ ì‹œìŠ¤í…œ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .video-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .video-stream {
            border: 2px solid #ddd;
            border-radius: 10px;
            max-width: 100%;
            height: auto;
        }
        
        .control-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        .control-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-warning:hover { background-color: #e0a800; }
        
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-info:hover { background-color: #138496; }
        
        #control-panel { 
            display: none; 
            margin-top: 20px; 
        }
        
        #joystick-zone { 
            width: 200px; 
            height: 200px; 
            margin: 20px auto;
            border: 2px solid #ddd;
            border-radius: 50%;
            background-color: #f8f9fa;
        }
        
        .action-buttons {
            text-align: center;
            margin: 20px 0;
        }
        
        .action-btn { 
            width: 120px; 
            font-size: 1em; 
            margin: 10px; 
        }
        
        .status-display {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .log-area {
            background-color: #212529;
            color: #ffffff;
            padding: 15px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-on { background-color: #28a745; }
        .status-off { background-color: #dc3545; }
        .status-scanning { background-color: #ffc107; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– Unitree ì œì–´ ì‹œìŠ¤í…œ</h1>
        
        <!-- ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì„¹ì…˜ -->
        <div class="video-section">
            <h2>ğŸ“¹ ì‹¤ì‹œê°„ ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼</h2>
            <img src="{{ url_for('video_feed') }}" class="video-stream" width="640" height="360" />
        </div>

        <!-- ì‹œìŠ¤í…œ ì‹œì‘ ë²„íŠ¼ -->
        <div class="control-section">
            <h3>ğŸš€ ì‹œìŠ¤í…œ ì œì–´</h3>
            <button id="slam-btn" class="btn btn-primary">START CONTROL</button>
            <button id="exit-btn" class="btn btn-danger" style="display:none;">EXIT</button>
        </div>

        <!-- ğŸ†• ArUco ì‹ ì› í™•ì¸ ì‹œìŠ¤í…œ -->
        <div class="control-section">
            <h3>ğŸ”– ArUco ì‹ ì› í™•ì¸ ì‹œìŠ¤í…œ</h3>
            <p style="margin: 5px 0; color: #666;">
                ğŸ“‹ <strong>í”„ë¡œì„¸ìŠ¤:</strong> SIT ë²„íŠ¼ â†’ YOLO ë¹„í™œì„±í™” â†’ ArUco ë§ˆì»¤ ìŠ¤ìº” â†’ ì‹ ì› í™•ì¸ â†’ Discord ì•Œë¦¼
            </p>
            <div class="status-display" id="aruco-status">
                <span class="status-indicator status-off"></span>
                <strong>ArUco ìŠ¤ìº”:</strong> <span id="aruco-status-text">ëŒ€ê¸° ì¤‘</span>
            </div>
            <button onclick="startArUcoScan()" class="btn btn-success">
                ğŸ”– ArUco ì‹ ì› ìŠ¤ìº” ì‹œì‘
            </button>
            <button onclick="stopArUcoScan()" class="btn btn-danger">
                ğŸ›‘ ArUco ìŠ¤ìº” ì¤‘ì§€
            </button>
            <button onclick="checkArUcoStatus()" class="btn btn-info">
                ğŸ“Š ArUco ìƒíƒœ í™•ì¸
            </button>
        </div>

        <!-- ë©”ì¸ ì œì–´ íŒ¨ë„ -->
        <div id="control-panel">
            <!-- ì¡°ì´ìŠ¤í‹± ì œì–´ -->
            <div class="control-section">
                <h3>ğŸ•¹ï¸ ì¡°ì´ìŠ¤í‹± ì œì–´</h3>
                <div id="joystick-zone"></div>
                <p style="text-align: center; color: #666;">
                    ì¡°ì´ìŠ¤í‹±ì„ ë“œë˜ê·¸í•˜ì—¬ ë¡œë´‡ì„ ì›€ì§ì´ì„¸ìš”
                </p>
            </div>

            <!-- ê¸°ë³¸ ë™ì‘ ë²„íŠ¼ë“¤ -->
            <div class="control-section">
                <h3>ğŸ¤– ê¸°ë³¸ ë™ì‘</h3>
                <div class="action-buttons">
                    <button class="action-btn btn btn-warning" onclick="move('sitdown')">SIT DOWN</button>
                    <button class="action-btn btn btn-success" onclick="move('situp')">STAND UP</button>
                    <button class="action-btn btn btn-info" onclick="move('sit')">SIT</button>
                </div>
            </div>
        </div>

        <!-- ì‹œìŠ¤í…œ ìƒíƒœ ë° ë¡œê·¸ -->
        <div class="control-section">
            <h3>ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ</h3>
            <div class="status-display" id="system-status">
                <span class="status-indicator status-off"></span>
                <strong>YOLO:</strong> <span id="yolo-status">í™œì„±í™”</span> | 
                <strong>ArUco:</strong> <span id="aruco-mode">ëŒ€ê¸°</span> | 
                <strong>ì—°ê²°:</strong> <span id="connection-status">ì¤€ë¹„</span>
            </div>
            
            <h4>ğŸ“ ì‹¤ì‹œê°„ ë¡œê·¸</h4>
            <div class="log-area" id="log-area">
                ì‹œìŠ¤í…œ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...
            </div>
            <button onclick="clearLog()" class="btn btn-warning" style="margin-top: 10px;">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <script>
        let joystick = null;
        let current = {x: 0, z: 0};
        let sending = false;
        let intervalId = null;
        let statusMonitorId = null;

        // ë¡œê·¸ í•¨ìˆ˜
        function addLog(message) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-area').innerHTML = 'ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤...\n';
        }

        // ì‹œìŠ¤í…œ ì‹œì‘
        document.getElementById('slam-btn').onclick = function() {
            fetch('/start_control', {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        document.getElementById('control-panel').style.display = 'block';
                        document.getElementById('slam-btn').style.display = 'none';
                        document.getElementById('exit-btn').style.display = 'inline-block';
                        addLog('ğŸš€ ì œì–´ ì‹œìŠ¤í…œì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        
                        if (!joystick) {
                            createJoystick();
                        }
                        startStatusMonitoring();
                    } else {
                        addLog('âŒ ì œì–´ ì‹œìŠ¤í…œ ì‹œì‘ ì‹¤íŒ¨');
                    }
                })
                .catch(error => {
                    addLog('âŒ í†µì‹  ì˜¤ë¥˜: ' + error);
                });
        };

        // ì‹œìŠ¤í…œ ì¢…ë£Œ
        document.getElementById('exit-btn').onclick = function() {
            document.getElementById('control-panel').style.display = 'none';
            document.getElementById('slam-btn').style.display = 'inline-block';
            document.getElementById('exit-btn').style.display = 'none';
            stopSending();
            stopStatusMonitoring();
            addLog('ğŸ›‘ ì œì–´ ì‹œìŠ¤í…œì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        };

        // ê¸°ë³¸ ë™ì‘ í•¨ìˆ˜
        function move(direction) {
            fetch('/move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ direction: direction })
            })
            .then(res => res.json())
            .then(data => {
                addLog(`ğŸ¤– ë™ì‘ ëª…ë ¹: ${direction}`);
            })
            .catch(error => {
                addLog('âŒ ë™ì‘ ëª…ë ¹ ì‹¤íŒ¨: ' + error);
            });
        }

        // ğŸ†• ArUco ì‹ ì› ìŠ¤ìº” ì‹œìŠ¤í…œ í•¨ìˆ˜ë“¤
        function startArUcoScan() {
            fetch('/start_aruco_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`ğŸ”– ArUco ì‹ ì› ìŠ¤ìº” ì‹œì‘!`);
                    addLog(`ğŸ“‹ ìµœëŒ€ ${data.max_attempts}ë²ˆ ì‹œë„, ${data.timeout}ì´ˆ íƒ€ì„ì•„ì›ƒ`);
                    addLog(`ğŸ¯ YOLO ëª¨ë¸ ë¹„í™œì„±í™”ë¨`);
                    updateArUcoStatus('scanning', 'ArUco ìŠ¤ìº” ì¤‘...');
                    startStatusMonitoring();
                } else {
                    addLog('âŒ ArUco ìŠ¤ìº” ì‹œì‘ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                addLog('âŒ ArUco ìŠ¤ìº” í†µì‹  ì˜¤ë¥˜');
            });
        }

        function stopArUcoScan() {
            fetch('/stop_aruco_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`ğŸ›‘ ArUco ìŠ¤ìº” ì¤‘ì§€ë¨! (${data.attempts_made}ë²ˆ ì‹œë„í•¨)`);
                    addLog(`ğŸ”„ YOLO ëª¨ë¸ ì¬í™œì„±í™”ë¨`);
                    updateArUcoStatus('off', 'ëŒ€ê¸° ì¤‘');
                } else {
                    addLog('âŒ ArUco ìŠ¤ìº” ì¤‘ì§€ ì‹¤íŒ¨: ' + data.message);
                }
            })
            .catch(error => {
                addLog('âŒ ArUco ìŠ¤ìº” ì¤‘ì§€ í†µì‹  ì˜¤ë¥˜');
            });
        }

        function checkArUcoStatus() {
            fetch('/aruco_scan_status')
            .then(response => response.json())
            .then(data => {
                addLog(`ğŸ“Š ArUco ìƒíƒœ:`);
                addLog(`   ìŠ¤ìº” ëª¨ë“œ: ${data.aruco_scan_mode ? 'ON' : 'OFF'}`);
                addLog(`   ì‹œë„ íšŸìˆ˜: ${data.aruco_scan_attempts}/${data.max_attempts}`);
                addLog(`   ë‚¨ì€ ì‹œê°„: ${data.remaining_time.toFixed(1)}ì´ˆ`);
                addLog(`   YOLO í™œì„±í™”: ${data.yolo_active ? 'ON' : 'OFF'}`);
            })
            .catch(error => {
                addLog('âŒ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨');
            });
        }

        function updateArUcoStatus(status, text) {
            const indicator = document.querySelector('#aruco-status .status-indicator');
            const statusText = document.getElementById('aruco-status-text');
            
            indicator.className = 'status-indicator';
            if (status === 'scanning') {
                indicator.classList.add('status-scanning');
            } else if (status === 'on') {
                indicator.classList.add('status-on');
            } else {
                indicator.classList.add('status-off');
            }
            
            statusText.textContent = text;
        }

        // ìƒíƒœ ëª¨ë‹ˆí„°ë§
        function startStatusMonitoring() {
            if (statusMonitorId) return;
            
            statusMonitorId = setInterval(() => {
                fetch('/aruco_scan_status')
                .then(response => response.json())
                .then(data => {
                    // YOLO ìƒíƒœ ì—…ë°ì´íŠ¸
                    document.getElementById('yolo-status').textContent = data.yolo_active ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”';
                    
                    // ArUco ëª¨ë“œ ì—…ë°ì´íŠ¸
                    if (data.aruco_scan_mode) {
                        document.getElementById('aruco-mode').textContent = `ìŠ¤ìº” ì¤‘ (${data.aruco_scan_attempts}/${data.max_attempts})`;
                        updateArUcoStatus('scanning', `ìŠ¤ìº” ì¤‘... ${data.aruco_scan_attempts}/${data.max_attempts}`);
                    } else {
                        document.getElementById('aruco-mode').textContent = 'ëŒ€ê¸°';
                        updateArUcoStatus('off', 'ëŒ€ê¸° ì¤‘');
                    }
                    
                    // ì—°ê²° ìƒíƒœ
                    document.getElementById('connection-status').textContent = 'ì—°ê²°ë¨';
                })
                .catch(error => {
                    document.getElementById('connection-status').textContent = 'ì—°ê²° ì˜¤ë¥˜';
                });
            }, 2000); // 2ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
        }

        function stopStatusMonitoring() {
            if (statusMonitorId) {
                clearInterval(statusMonitorId);
                statusMonitorId = null;
            }
        }

        // ì¡°ì´ìŠ¤í‹± ìƒì„±
        function createJoystick() {
            joystick = nipplejs.create({
                zone: document.getElementById('joystick-zone'),
                mode: 'static',
                position: { left: '50%', top: '50%' },
                color: 'blue',
                size: 150
            });

            joystick.on('move', function(evt, data) {
                if (data && data.distance > 10) {
                    let rad = data.angle.radian;
                    // yì¶•(ì„¸ë¡œ) â†’ x(ì „í›„), xì¶•(ê°€ë¡œ) â†’ z(íšŒì „)
                    let x = Math.sin(rad) * (data.distance / 100); // -1 ~ 1 (ì „í›„)
                    let z = Math.cos(rad) * (data.distance / -75); // -1 ~ 1 (íšŒì „)
                    current.x = x;
                    current.z = z;
                } else {
                    current.x = 0;
                    current.z = 0;
                }
                if (!sending) startSending();
            });

            joystick.on('end', function() {
                current.x = 0;
                current.z = 0;
                sendJoy(0, 0);
                stopSending();
            });
        }

        // ì¡°ì´ìŠ¤í‹± ì „ì†¡
        function startSending() {
            sending = true;
            if (intervalId) return;
            intervalId = setInterval(() => {
                sendJoy(current.x, current.z);
            }, 50); // 50msë§ˆë‹¤ ì „ì†¡
        }

        function stopSending() {
            sending = false;
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        function sendJoy(x, z) {
            fetch('/joystick', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ x: x, z: z })
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            addLog('ğŸŒŸ ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.');
            addLog('ğŸ“‹ START CONTROLì„ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.');
        };
    </script>
</body>
</html>