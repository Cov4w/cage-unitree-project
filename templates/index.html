<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Unitree 제어 시스템</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1400px; /* 가로 레이아웃을 위해 더 넓게 */
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* 🆕 가로 배치를 위한 메인 컨테이너 */
        .main-layout {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        
        /* 🆕 비디오 섹션 스타일 수정 */
        .video-section {
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease; /* 부드러운 전환 */
        }
        
        .video-section.expanded {
            /* START CONTROL 후 비디오가 왼쪽으로 이동 */
            flex: 0 0 600px; /* 고정 너비 */
            margin-bottom: 0;
        }
        
        .video-stream {
            border: 2px solid #ddd;
            border-radius: 10px;
            max-width: 100%;
            height: auto;
        }
        
        /* 🆕 제어 패널이 오른쪽에 표시될 영역 */
        .control-sidebar {
            flex: 1;
            min-width: 300px;
            display: none; /* 초기에는 숨김 */
        }
        
        .control-sidebar.active {
            display: block;
            animation: slideInRight 0.3s ease-out; /* 슬라이드 애니메이션 */
        }
        
        /* 🆕 슬라이드 애니메이션 */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .control-section {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        .control-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        
        .btn-success { background-color: #28a745; color: white; }
        .btn-success:hover { background-color: #1e7e34; }
        
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }
        
        .btn-warning { background-color: #ffc107; color: black; }
        .btn-warning:hover { background-color: #e0a800; }
        
        .btn-info { background-color: #17a2b8; color: white; }
        .btn-info:hover { background-color: #138496; }
        
        /* 🔧 조이스틱 영역 개선된 스타일 */
        #joystick-zone { 
            width: 200px; 
            height: 200px; 
            margin: 20px auto;
            border: 3px solid #007bff;
            border-radius: 50%;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            position: relative;
            overflow: visible;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        /* 🔧 조이스틱 호버 효과 */
        #joystick-zone:hover {
            border-color: #0056b3;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.15), 0 0 15px rgba(0,123,255,0.4);
            transform: scale(1.02);
        }
        
        /* 🔧 조이스틱 활성화 상태 */
        #joystick-zone.active {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.15), 0 0 20px rgba(40,167,69,0.5);
        }
        
        .action-buttons {
            text-align: center;
            margin: 20px 0;
        }
        
        .action-btn { 
            width: 120px; 
            font-size: 1em; 
            margin: 10px; 
        }
        
        .status-display {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        
        .log-area {
            background-color: #212529;
            color: #ffffff;
            padding: 15px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-on { background-color: #28a745; }
        .status-off { background-color: #dc3545; }
        .status-scanning { background-color: #ffc107; }
        
        /* 🆕 전체 폭 사용하는 섹션들 */
        .full-width-section {
            width: 98%;
            margin: 20px 0;
        }
        
        /* 🆕 반응형 디자인 */
        @media (max-width: 1200px) {
            .main-layout {
                flex-direction: column;
            }
            
            .video-section.expanded {
                flex: none;
            }
            
            .control-sidebar {
                min-width: auto;
            }
        }
        
        /* 🔧 반응형 조이스틱 */
        @media (max-width: 768px) {
            #joystick-zone {
                width: 160px;
                height: 160px;
            }
        }
        
        @media (min-width: 1400px) {
            #joystick-zone {
                width: 240px;
                height: 240px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>🤖 Unitree 제어 시스템</h1>
        
        <!-- 시스템 시작 버튼 (전체 폭) -->
        <div class="control-section full-width-section">
            <h3>🚀 시스템 제어</h3>
            <button id="slam-btn" class="btn btn-primary">START CONTROL</button>
            <button id="exit-btn" class="btn btn-danger" style="display:none;">EXIT</button>
        </div>

        <!-- ArUco 신원 확인 시스템 (전체 폭) -->
        <div class="control-section full-width-section">
            <h3>🔖 ArUco 신원 확인 시스템</h3>
            <p style="margin: 5px 0; color: #666;">
                📋 <strong>프로세스:</strong> SIT 버튼 → YOLO 비활성화 → ArUco 마커 스캔 → 신원 확인 → Discord 알림 → <strong>자동 STANDUP 복구</strong>
            </p>
            <div class="status-display" id="aruco-status">
                <span class="status-indicator status-off"></span>
                <strong>ArUco 스캔:</strong> <span id="aruco-status-text">대기 중</span>
            </div>
            <button onclick="startArUcoScan()" class="btn btn-success">
                🔖 ArUco 신원 스캔 시작
            </button>
            <button onclick="stopArUcoScan()" class="btn btn-danger">
                🛑 ArUco 스캔 중지 & 복구
            </button>
            <button onclick="checkArUcoStatus()" class="btn btn-info">
                📊 ArUco 상태 확인
            </button>
            <button onclick="checkRobotStatus()" class="btn btn-warning">
                🤖 로봇 상태 확인
            </button>
        </div>

        <!-- 🆕 메인 레이아웃: 비디오 + 제어 패널 -->
        <div class="main-layout">
            <!-- 비디오 스트림 섹션 -->
            <div class="video-section" id="video-section">
                <h2>📹 실시간 비디오 스트림</h2>
                <img src="{{ url_for('video_feed') }}" class="video-stream" width="640" height="360" />
            </div>

            <!-- 🆕 제어 사이드바 (START CONTROL 후에 표시) -->
            <div class="control-sidebar" id="control-sidebar">
                <!-- 조이스틱 제어 -->
                <div class="control-section">
                    <h3>🕹️ 조이스틱 제어</h3>
                    <div id="joystick-zone"></div>
                    <p style="text-align: center; color: #666; font-size: 0.9em;">
                        조이스틱을 드래그하여 로봇을 움직이세요
                    </p>
                </div>

                <!-- 기본 동작 버튼들 -->
                <div class="control-section">
                    <h3>🤖 기본 동작</h3>
                    <div class="action-buttons">
                        <button class="action-btn btn btn-warning" onclick="move('sitdown')">SIT DOWN</button>
                        <button class="action-btn btn btn-success" onclick="move('situp')">STAND UP</button>
                        <button class="action-btn btn btn-info" onclick="move('sit')">SIT</button>
                    </div>
                </div>

                <!-- 🔧 간소화된 오디오 제어 -->
                <div class="control-section">
                    <h3>🎵 음성 채널 연동</h3>
                    <div class="action-buttons">
                        <button class="action-btn btn btn-success" onclick="connectVoiceChannel()">
                            🔗 음성 연결 & 브리지 시작
                        </button>
                        <button class="action-btn btn btn-danger" onclick="disconnectVoiceChannel()">
                            🔇 브리지 중지 & 퇴장
                        </button>
                    </div>
                    <div class="status-display" id="voice-status">
                        <span class="status-indicator status-off"></span>
                        <strong>음성 상태:</strong> <span id="voice-status-text">비활성화</span>
                    </div>
                    <p style="text-align: center; color: #666; font-size: 0.9em;">
                        Discord 음성 채널과 로봇 오디오를 연동합니다<br>
                        <strong>연결 시 자동으로 양방향 브리지가 활성화됩니다</strong>
                    </p>
                </div>
            </div>
        </div>

        <!-- 시스템 상태 및 로그 (전체 폭) -->
        <div class="control-section full-width-section">
            <h3>📊 시스템 상태</h3>
            <div class="status-display" id="system-status">
                <span class="status-indicator status-off"></span>
                <strong>YOLO:</strong> <span id="yolo-status">활성화</span> | 
                <strong>ArUco:</strong> <span id="aruco-mode">대기</span> | 
                <strong>연결:</strong> <span id="connection-status">준비</span>
            </div>
            
            <h4>📝 실시간 로그</h4>
            <div class="log-area" id="log-area">
                시스템 로그가 여기에 표시됩니다...
            </div>
            <button onclick="clearLog()" class="btn btn-warning" style="margin-top: 10px;">🗑️ 로그 지우기</button>
        </div>
    </div>

    <script>
        let joystick = null;
        let current = {x: 0, z: 0};
        let sending = false;
        let intervalId = null;
        let statusMonitorId = null;

        // 로그 함수
        function addLog(message) {
            const logArea = document.getElementById('log-area');
            const timestamp = new Date().toLocaleTimeString();
            logArea.innerHTML += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-area').innerHTML = '로그가 지워졌습니다...\n';
        }

        // 🆕 음성 관련 JavaScript 함수들 추가
        function connectVoiceChannel() {
            fetch('/voice_connect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog('🔗 Discord 음성 채널 연결 및 브리지 시작 요청됨');
                    addLog('🎵 자동으로 양방향 음성 브리지가 활성화됩니다');
                    updateVoiceStatus('connecting', '연결 중...');
                    
                    // 5초 후 상태 확인
                    setTimeout(checkVoiceStatus, 5000);
                } else {
                    addLog('❌ 음성 채널 연결 실패: ' + data.message);
                    updateVoiceStatus('off', '연결 실패');
                }
            })
            .catch(error => {
                addLog('❌ 음성 채널 연결 오류: ' + error);
                updateVoiceStatus('off', '연결 오류');
            });
        }

        function disconnectVoiceChannel() {
            fetch('/voice_disconnect', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog('🔇 음성 브리지 중지 및 Discord 봇 퇴장 요청됨');
                    addLog('🤖 자동으로 모든 음성 연결이 해제됩니다');
                    updateVoiceStatus('off', '비활성화');
                } else {
                    addLog('❌ 음성 채널 연결 해제 실패: ' + data.message);
                }
            })
            .catch(error => {
                addLog('❌ 음성 채널 연결 해제 오류: ' + error);
            });
        }

        function updateVoiceStatus(status, text) {
            const indicator = document.querySelector('#voice-status .status-indicator');
            const statusText = document.getElementById('voice-status-text');
            
            indicator.className = 'status-indicator';
            if (status === 'active') {
                indicator.classList.add('status-on');
            } else if (status === 'connecting') {
                indicator.classList.add('status-scanning');
            } else {
                indicator.classList.add('status-off');
            }
            
            statusText.textContent = text;
        }

        function checkVoiceStatus() {
            fetch('/voice_status')
            .then(response => response.json())
            .then(data => {
                if (data.voice_connected && data.bridge_active) {
                    updateVoiceStatus('active', '양방향 브리지 활성화');
                    addLog('✅ 음성 연결 및 브리지 활성화 완료!');
                    addLog('🗣️ Discord 음성 → 로봇 스피커');
                    addLog('🔊 로봇 마이크 → Discord 음성');
                } else if (data.voice_connected) {
                    updateVoiceStatus('connecting', '연결됨 (브리지 대기)');
                } else {
                    updateVoiceStatus('off', '비활성화');
                }
            })
            .catch(error => {
                console.error('음성 상태 확인 오류:', error);
                updateVoiceStatus('off', '상태 확인 실패');
            });
        }

        // 🔧 시스템 시작 (레이아웃 변경 포함)
        document.getElementById('slam-btn').onclick = function() {
            fetch('/start_control', {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'ok') {
                        // 🆕 레이아웃 변경 - 비디오를 왼쪽으로, 제어패널을 오른쪽으로
                        document.getElementById('video-section').classList.add('expanded');
                        document.getElementById('control-sidebar').classList.add('active');
                        
                        // 버튼 상태 변경
                        document.getElementById('slam-btn').style.display = 'none';
                        document.getElementById('exit-btn').style.display = 'inline-block';
                        
                        addLog('🚀 제어 시스템이 시작되었습니다.');
                        addLog('🔄 레이아웃이 가로 배치로 변경되었습니다.');
                        
                        // 🔧 조이스틱 생성 (레이아웃 변경 후)
                        if (!joystick) {
                            setTimeout(createJoystick, 300); // 레이아웃 변경 완료 대기
                        }
                        startStatusMonitoring();
                    } else {
                        addLog('❌ 제어 시스템 시작 실패');
                    }
                })
                .catch(error => {
                    addLog('❌ 통신 오류: ' + error);
                });
        };

        // 🔧 시스템 종료 (레이아웃 복원 포함)
        document.getElementById('exit-btn').onclick = function() {
            // 🆕 레이아웃 복원 - 원래 세로 배치로
            document.getElementById('video-section').classList.remove('expanded');
            document.getElementById('control-sidebar').classList.remove('active');
            
            // 버튼 상태 변경
            document.getElementById('slam-btn').style.display = 'inline-block';
            document.getElementById('exit-btn').style.display = 'none';
            
            stopSending();
            stopStatusMonitoring();
            
            // 조이스틱 제거
            if (joystick) {
                joystick.destroy();
                joystick = null;
            }
            
            addLog('🛑 제어 시스템이 종료되었습니다.');
            addLog('🔄 레이아웃이 원래대로 복원되었습니다.');
        };

        // 기본 동작 함수 (기존 유지)
        function move(direction) {
            fetch('/move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ direction: direction })
            })
            .then(res => res.json())
            .then (data => {
                addLog(`🤖 동작 명령: ${direction}`);
            })
            .catch(error => {
                addLog('❌ 동작 명령 실패: ' + error);
            });
        }

        // ArUco 함수들 (기존 유지)
        function startArUcoScan() {
            fetch('/start_aruco_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`🔖 ArUco 신원 스캔 시작!`);
                    addLog(`📋 최대 ${data.max_attempts}번 시도, ${data.timeout}초 타임아웃`);
                    addLog(`🎯 YOLO 모델 비활성화됨`);
                    updateArUcoStatus('scanning', 'ArUco 스캔 중...');
                    startStatusMonitoring();
                } else {
                    addLog('❌ ArUco 스캔 시작 실패: ' + data.message);
                }
            })
            .catch(error => {
                addLog('❌ ArUco 스캔 통신 오류');
            });
        }

        // 🆕 ArUco 스캔 중지 함수 개선
        function stopArUcoScan() {
            fetch('/stop_aruco_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    addLog(`🛑 ArUco 스캔 중지됨! (${data.attempts_made}번 시도함)`);
                    addLog(`🔄 YOLO 모델 재활성화됨`);
                    
                    // 🆕 로봇 복구 상태 표시
                    if (data.robot_recovered) {
                        addLog(`🤖 로봇 자세 복구 완료 (이전 상태: ${data.previous_robot_state})`);
                        addLog(`🤖 현재 로봇이 standup 자세로 복귀했습니다`);
                    }
                    
                    updateArUcoStatus('off', '대기 중 (복구 완료)');
                    
                    // 3초 후 상태 메시지 정리
                    setTimeout(() => {
                        updateArUcoStatus('off', '대기 중');
                    }, 3000);
                    
                } else {
                    addLog('❌ ArUco 스캔 중지 실패: ' + data.message);
                }
            })
            .catch(error => {
                addLog('❌ ArUco 스캔 중지 통신 오류');
            });
        }

        function checkArUcoStatus() {
            fetch('/aruco_scan_status')
            .then(response => response.json())
            .then(data => {
                addLog(`📊 ArUco 상태:`);
                addLog(`   스캔 모드: ${data.aruco_scan_mode ? 'ON' : 'OFF'}`);
                addLog(`   시도 횟수: ${data.aruco_scan_attempts}/${data.max_attempts}`);
                addLog(`   남은 시간: ${data.remaining_time.toFixed(1)}초`);
                addLog(`   YOLO 활성화: ${data.yolo_active ? 'ON' : 'OFF'}`);
            })
            .catch(error => {
                addLog('❌ 상태 확인 실패');
            });
        }

        function updateArUcoStatus(status, text) {
            const indicator = document.querySelector('#aruco-status .status-indicator');
            const statusText = document.getElementById('aruco-status-text');
            
            indicator.className = 'status-indicator';
            if (status === 'scanning') {
                indicator.classList.add('status-scanning');
            } else if (status === 'on') {
                indicator.classList.add('status-on');
            } else {
                indicator.classList.add('status-off');
            }
            
            statusText.textContent = text;
        }

        // 🔧 상태 모니터링에 음성 상태 추가
        function startStatusMonitoring() {
            if (statusMonitorId) return;
            
            statusMonitorId = setInterval(() => {
                // 기존 ArUco 상태 확인
                fetch('/aruco_scan_status')
                .then(response => response.json())
                .then(data => {
                    // YOLO 상태 업데이트
                    document.getElementById('yolo-status').textContent = data.yolo_active ? '활성화' : '비활성화';
                    
                    // ArUco 모드 업데이트
                    if (data.aruco_scan_mode) {
                        document.getElementById('aruco-mode').textContent = `스캔 중 (${data.aruco_scan_attempts}/${data.max_attempts})`;
                        updateArUcoStatus('scanning', `스캔 중... ${data.aruco_scan_attempts}/${data.max_attempts}`);
                    } else {
                        document.getElementById('aruco-mode').textContent = '대기';
                        updateArUcoStatus('off', '대기 중');
                    }
                    
                    // 연결 상태
                    document.getElementById('connection-status').textContent = '연결됨';
                })
                .catch(error => {
                    document.getElementById('connection-status').textContent = '연결 오류';
                });
                
                // 🆕 음성 상태 확인 추가
                checkVoiceStatus();
                
            }, 3000); // 3초마다 상태 확인
        }

        function stopStatusMonitoring() {
            if (statusMonitorId) {
                clearInterval(statusMonitorId);
                statusMonitorId = null;
            }
        }

        // 🔧 조이스틱 생성 함수 (기존 로직 유지)
        function createJoystick() {
            console.log('🕹️ 조이스틱 생성 시작...');
            
            const joystickZone = document.getElementById('joystick-zone');
            if (!joystickZone) {
                console.error('❌ joystick-zone 요소를 찾을 수 없습니다.');
                addLog('❌ 조이스틱 영역을 찾을 수 없습니다.');
                return;
            }

            // 기존 조이스틱이 있다면 제거
            if (joystick) {
                try {
                    joystick.destroy();
                } catch (e) {
                    console.warn('⚠️ 조이스틱 제거 중 경고:', e);
                }
                joystick = null;
            }

            // 🔧 레이아웃 변경 완료 대기
            setTimeout(() => {
                try {
                    // 🔧 joystick-zone 크기 측정
                    const zoneRect = joystickZone.getBoundingClientRect();
                    const zoneSize = Math.min(zoneRect.width, zoneRect.height);
                    const joystickSize = Math.floor(zoneSize * 0.7); // zone의 70%
                    
                    console.log(`🎯 조이스틱 크기: ${joystickSize}px`);

                    // 🔧 nipplejs 조이스틱 생성 (기존 설정 유지)
                    joystick = nipplejs.create({
                        zone: joystickZone,
                        mode: 'static',
                        position: { left: '50%', top: '50%' },
                        color: 'blue',
                        size: joystickSize > 0 ? joystickSize : 150 // 기본값 150
                    });

                    // 🔧 기존 이벤트 핸들러 완전히 유지
                    joystick.on('move', function(evt, data) {
                        if (data && data.distance > 10) {
                            let rad = data.angle.radian;
                            let x = Math.sin(rad) * (data.distance / 100);
                            let z = Math.cos(rad) * (data.distance / -75);
                            current.x = x;
                            current.z = z;
                        } else {
                            current.x = 0;
                            current.z = 0;
                        }
                        if (!sending) startSending();
                    });

                    joystick.on('end', function() {
                        current.x = 0;
                        current.z = 0;
                        sendJoy(0, 0);
                        stopSending();
                        joystickZone.classList.remove('active');
                    });

                    joystick.on('start', function() {
                        joystickZone.classList.add('active');
                    });
                    
                    addLog(`✅ 조이스틱 생성 완료`);
                    console.log('🎉 조이스틱 생성 완료');
                    
                } catch (error) {
                    console.error('❌ 조이스틱 생성 실패:', error);
                    addLog('❌ 조이스틱 생성 실패: ' + error.message);
                }
            }, 300);
        }

        // 🔧 기존 전송 함수들 완전히 유지
        function startSending() {
            sending = true;
            if (intervalId) return;
            intervalId = setInterval(() => {
                sendJoy(current.x, current.z);
            }, 25);
        }

        function stopSending() {
            sending = false;
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        function sendJoy(x, z) {
            fetch('/joystick', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ x: x, z: z })
            });
        }

        // 페이지 로드 시 초기화
        window.onload = function() {
            addLog('🌟 시스템이 준비되었습니다.');
            addLog('📋 START CONTROL을 눌러 시작하세요.');
            
            // 🆕 페이지 로드 시 음성 상태 한 번 확인
            setTimeout(checkVoiceStatus, 1000);
        };
    </script>
</body>
</html>